from sqlite3 import *

DB_NAME = 'telebot_db'

con = connect(DB_NAME)
cur = con.cursor()


# Проверка: есть ли пользователь в БД
def check_chatID(chID, usID):
    res = cur.execute('''SELECT chat_id FROM main''').fetchall()
    if chID not in res:
        cur.execute(f'INSERT INTO main(chat_id, user_id) VALUES({chID}, {usID}')
        con.commit()


# Поставить фильму оценку
def film_vote(chID, usID, score, name, genre):
    cur.execute(f'INSERT INTO score(user_id,score, name, ID_chat) VALUES({usID},{score},{name},{genre}, {chID}')
    con.commit()


# Вернуть список запланированных фильмов
def list_memory(chID):
    res = cur.execute('''SELECT user_id name ID_chat FROM list ''').fetchall()
    list_name = []
    for i in res:
        if i[-1] == chID:
            list_name += [i[1]]
    if len(list_name) == 0:
        return 'У вас нет запланированных фильмов'
    else:
        return list_name


# Добавить запланированный фильм
def add_memory(chID, usID, name):
    cur.execute(f'INSERT INTO list(user_id, name, ID_chat) VALUES({usID}, {name}, {chID}')
    con.commit()


# Удаление запланированного фильма
def remove_memory(chID, usID, name):
    cur.execute(f'DELETE FROM list WHERE name = {name} AND user_id = {usID} AND ID_chat = {chID}')
    con.commit()


# Добавить уведомление к фильму
def add_notification(chID, usID, name):
    cur.execute(f'INSERT INTO notification(user_id, name, ID_chat) VALUES({usID}, {name}, {chID}')
    con.commit()


# Удаление запланированного фильма
def remove_notification(chID, usID, name):
    cur.execute(f'DELETE FROM notification WHERE name = {name} AND user_id = {usID} AND ID_chat = {chID}')
    con.commit()


# Возвращение любимых жанров пользователя
def top_ganre_user(chID, usID):
    res = cur.execute(f'SELECT score, genre FROM score WHERE ID_chat = {chID} AND user_id = {usID}').fetchall()
    res.sort(reverse=True)
    top_genre = []
    for score, genre in res:
        if genre not in top_genre:
            top_genre += [genre]
    return top_genre


# Выдача топ 5 лучших фильмов пользователей бота
def top_list_b():
    slov_film = {}
    res = cur.execute(f'SELECT score, name FROM score').fetchall()
    for score, name in res:
        if name not in slov_film:
            slov_film[name] = (score, 1)
        else:
            slov_film[name] = (slov_film[name][0] + score, slov_film[name][1] + 1)
    for i in slov_film:
        slov_film[i] = (slov_film[i][0], round(slov_film[i][0] / slov_film[i][1], 1))
    res_slov_film = dict(sorted(slov_film.values(), key=lambda x: x[1], reverse=True))
    res_sp = []
    for i in res_slov_film:
        res_sp += [res_slov_film[i][0]]
        if len(res_sp) == 5:
            break
    return res_sp


# Выдать список запланированных фильмов, серий и т.д
def get_notif_film(chID, usID):
    res = cur.execute(f'SELECT name, ID_chat FROM notification WHERE user_id = {usID} AND ID_chat = {chID}').fetchall()
    return res
